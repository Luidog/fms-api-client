<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>models/connection.model.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Agent.html">Agent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.globalize">globalize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.handleError">handleError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.handleRequest">handleRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.handleResponse">handleResponse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.localize">localize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.mutate">mutate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.push">push</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.request">request</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.resolve">resolve</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.shift">shift</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#.watch">watch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#preDelete">preDelete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Agent.html#preInit">preInit</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Client.html">Client</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#._save">_save</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.databases">databases</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.delete">delete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.destroy">destroy</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.duplicate">duplicate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.edit">edit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.find">find</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.globals">globals</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.layout">layout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.layouts">layouts</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.list">list</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.login">login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.logout">logout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.productInfo">productInfo</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.reset">reset</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.run">run</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.script">script</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.scripts">scripts</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.status">status</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#.upload">upload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#preDelete">preDelete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#preInit">preInit</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Connection.html">Connection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connection.html#.authentication">authentication</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connection.html#.available">available</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connection.html#.clear">clear</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connection.html#.end">end</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connection.html#.extend">extend</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connection.html#.ready">ready</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connection.html#.save">save</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Connection.html#.starts">starts</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="global.html#Credentials">Credentials</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#Credentials#.basic">basic</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Data.html">Data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Data.html#.clear">clear</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Data.html#.incoming">incoming</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Data.html#.outgoing">outgoing</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Data.html#.status">status</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Session.html">Session</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Session.html#.expired">expired</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Session.html#.extend">extend</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Session.html#.valid">valid</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="urls.html">urls</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.authentication">authentication</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.databases">databases</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.delete">delete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.duplicate">duplicate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.find">find</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.globals">globals</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.layout">layout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.layouts">layouts</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.list">list</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.logout">logout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.productInfo">productInfo</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.script">script</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.scripts">scripts</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.update">update</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="urls.html#.upload">upload</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#AGENTS%255Bundefined%255D">AGENTS[undefined]</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#FMS_API_CLIENT">FMS_API_CLIENT</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#interceptError">interceptError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#preInit">preInit</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">models/connection.model.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const _ = require('lodash');
const moment = require('moment');
const { EmbeddedDocument } = require('marpat');
const { Credentials } = require('./credentials.model');
const { Session } = require('./session.model');
const { urls } = require('../utilities');
const { instance } = require('../services');

/**
 * @class Connection
 * @classdesc The class used to connection with the FileMaker server Data API
 * @constructor
 */
class Connection extends EmbeddedDocument {
  /** @constructs */
  constructor() {
    super();
    this.schema({
      /**
       * The client FileMaker Server.
       * @member Connection#server
       * @type String
       */
      server: {
        type: String,
        validate: data =>
          data.startsWith('http://') || data.startsWith('https://'),
        required: true
      },
      /**
       * The client database name.
       * @member Connection#database
       * @type String
       */
      database: {
        type: String,
        required: true
      },
      /**
       * The version of Data API to use.
       * @member Connection#version
       * @type String
       */
      version: {
        type: String,
        required: true,
        default: 'vLatest'
      },
      /**
       * Open Data API sessions.
       * @member Connection#starting
       * @see  {@link Session}
       * @type Boolean
       */
      starting: {
        type: Boolean,
        default: false
      },
      /**
       * Open Data API sessions.
       * @member Connection#sessions
       * @see  {@link Session}
       * @type Array
       */
      sessions: {
        type: [Session],
        default: () => []
      },
      /** A string containing the time the token token was issued.
       * @member Credentials
       * @type class
       */
      credentials: {
        type: Credentials,
        required: true
      }
    });
  }

  /**
   * @method preInit
   * @schema
   * @description The preInit method is called on creation of the connection. On creation this preInit will create a credential
   * embedded document.
   * @see  {@link [marpat]https://github.com/Luidog/marpat}
   * @param {Object} data The data used to create the connection.
   * @param {String} data.user The FileMaker user account to use when creating connections.
   * @param {String} data.password The FileMaker user account password.
   */
  preInit({ user, password }) {
    this.credentials = Credentials.create({ user, password });
  }

  /**
   * @method authentication
   * @public
   * @memberof Connection
   * @description the authentication method merges the request passed to it with authentication headers.
   * This method is used to ensure requests are sent with the latest available session authentication.
   * @param {Object} request The request to inject the authentication header
   * @param {Object} request.headers The headers to inject the authentication header into.
   * @see  {@link Connection#available}
   * @return {String} The session token.
   */
  authentication({ headers, ...request }) {
    return new Promise((resolve, reject) => {
      const sessions = _.sortBy(this.sessions, ['active', 'used'], ['desc']);
      const session = sessions[0];
      session.active = true;
      session.url = request.url;
      session.used = moment().format();
      resolve({
        ...request,
        headers: {
          ...headers,
          Authorization: `Bearer ${session.token}`
        }
      });
    });
  }

  /**
   * @method ready
   * @public
   * @memberof Connection
   * @description Saves a token retrieved from the Data API as a sessions
   * @see  {@link session}
   * @return {Boolean} data a boolean indicating if the connection has a session.
   */
  ready() {
    return this.sessions.length > 0;
  }

  /**
   * @method available
   * @public
   * @memberof Connection
   * @description Saves a token retrieved from the Data API as a sessions
   * @see  {@link session}
   * @return {Boolean|Class} data a false boolean or session
   */
  available() {
    const session = _.find(this.sessions, session => session.valid());
    return typeof session === 'undefined' ? false : session;
  }

  /**
   * @method save
   * @public
   * @memberof Connection
   * @description Saves a token retrieved from the Data API as a sessions
   * @see  {@link session}
   * @param {Object} data The FileMaker authentication response.
   * @return {String} a token retrieved from the private generation method
   */
  save(data) {
    this.starting = false;
    return new Promise((resolve, reject) => {
      if (!data.response || !data.response.token)
        reject({
          code: '1760',
          message: 'Unable to parse session token from server response.'
        });
      const session = Session.create({ token: data.response.token });
      this.sessions.push(session);
      this.clear();
      resolve({ token: session.token, id: session.id });
    });
  }

  /**
   * @method starts
   * @public
   * @memberof Connection
   * @description Starts a FileMaker Data API session
   * @param {Object} [agent] An optional custom request agent.
   * @return {String} The session token.
   */
  start(agent) {
    this.starting = true;
    return new Promise((resolve, reject) => {
      instance
        .request(
          Object.assign(
            {
              url: urls.authentication(
                this.server,
                this.database,
                this.version
              ),
              method: 'post',
              timeout: 3000
            },
            agent ? { ...agent } : {},
            {
              headers: {
                'Content-Type': 'application/json',
                authorization: this.credentials.basic()
              },
              data: {}
            }
          )
        )
        .then(response => response.data)
        .then(body => this.save(body))
        .then(token => resolve(token))
        .catch(error => {
          this.starting = false;
          reject(error);
        });
    });
  }

  /**
   * @method end
   * @public
   * @memberof Connection
   * @description ends a FileMaker Data API session and clears the session.
   * @see  {@link Connection#clear}
   * @param {Object} [agent] An optional custom request agent.
   * @param {String} [id] The session id to log out.
   * @return {String} The session token.
   */
  end(agent, id = false) {
    return new Promise((resolve, reject) => {
      const session = id ? _.find(this.sessions, { id }) : this.available();
      if (session) {
        session.active = true;
        instance
          .request(
            Object.assign(
              {
                url: urls.logout(
                  this.server,
                  this.database,
                  session.token,
                  this.version
                ),
                method: 'delete',
                data: {}
              },
              agent ? { ...agent } : {}
            )
          )
          .then(response => {
            this.clear(session.token);
            resolve(response.data);
          })
          .catch(error => reject(error));
      } else {
        reject({ message: 'No session to Log out' });
      }
    });
  }

  /**
   * @method clear
   * @memberof Connection
   * @public
   * @description clears the currently saved token, expiration, and issued data by setting them to empty strings. This method
   * returns whatever is passed to it unmodified.
   * @param {String} [header] The header containing the token to clear.
   */
  clear(header) {
    this.sessions = this.sessions.filter(session =>
      typeof header === 'string'
        ? header.replace('Bearer ', '') !== session.token &amp;&amp; !session.expired()
        : !session.expired()
    );
  }

  /**
   * @method extend
   * @memberof Connection
   * @public
   * @description Saves a token retrieved from the Data API. This method returns the response recieved to it unmodified.
   * @param {String} [header] The header containing the token to clear.
   */
  extend(header) {
    const token = header.replace('Bearer ', '');
    const session = _.find(this.sessions, session => session.token === token);
    if (session) session.extend();
  }
}

module.exports = {
  Connection
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Sun Sep 15 2019 15:32:30 GMT-0700 (Pacific Daylight Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
